---
title: "Arf6 mouse tumor RNAseq experiment"
author: "Matt Cannon"
date: "03-02-2022"
output: knitrBootstrap::bootstrap_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      cache = TRUE)
```

# RNAseq analysis of zebrafish, human and mouse tumors

## Goals:


## Samples:
Zebrafish fusion samples
    /gpfs0/home1/gdkendalllab/lab/raw_data/fastq/2016_01_01/
    sample     tumor   fusion         background
    A667T19    D738    VGLL2-NCOA2    P53-/-
    A667T20    D739    VGLL2-NCOA2    AB/TL
    A667T21    D742    VGLL2-NCOA2    P53-/-
    A667T22    D777    VGLL2-NCOA2    AB/TL
    A667T23    D799    VGLL2-NCOA2    AB/TL
    A667T24    D800    VGLL2-NCOA2    AB/TL
    A667T25    D801    VGLL2-NCOA2    AB/TL
    A667T26    D807    VGLL2-NCOA2    AB/TL
    A667T27    D808    VGLL2-NCOA2    AB/TL
    A667T28    D813-Head    VGLL2-NCOA2    AB/TL
    A667T29    D813-Tail    VGLL2-NCOA2    AB/TL
    D809    D809    VGLL2-NCOA2    AB/TL
    D811    D811    VGLL2-NCOA2    AB/TL
    D812-head   D812-head    VGLL2-NCOA2    AB/TL
    D812-tail   D812-tail    VGLL2-NCOA2    AB/TL
    D814    D814    VGLL2-NCOA2    AB/TL
    D815    D815    VGLL2-NCOA2    AB/TL
    D874    D874    VGLL2-NCOA2    AB/TL

Zebrafish P53/Kras mutant fish
    SRR6507311 mutant
    SRR6507312 mutant
    SRR6507313 mutant
    SRR6507300 whole fish
    SRR6507301 whole fish
    SRR6507302 whole fish

Zebrafish normal muscle
    /home/gdkendalllab/lab/raw_data/fastq/2016_01_02
    A374-A375T23
    A374-A375T24
    D948 muscle
    D949 muscle
    D950 muscle
    D951 muscle
    D952 muscle

Zebrafish CICDUX4 tumors
    D655
    D668
    D669
    D678
    D681
    D682
    D684
    D685
    D686
    D687
    D688
    D689

Mouse data from fusion in C2C12 cells
    /gpfs0/home1/gdkendalllab/lab/raw_data/fastq/2015_12_22/
    A377-A378T1 - A377-A378T8
    T7 and T8 are controls with C2C12 without fusion expression

Mouse normal skeletal muscle from SRA
    PRJNA625451
    PRJNA608179 - Miiice in spaaaaace
    PRJNA819493 - 14, 36 weeks
    PRJNA813153

Human data from patient fusion tumors
    /gpfs0/home1/gdkendalllab/lab/raw_data/fastq/2016_12_14/
    EGAR00001508614_SARC061
    EGAR00001508618_SARC065
    EGAR00001508623_SARC070-Primary
    EGAR00001508624_SARC070-Relapse1
    EGAR00001508656_SARC102

Normal human skeletal muscle data from GTEx
https://storage.googleapis.com/gtex_analysis_v8/rna_seq_data/gene_reads/gene_reads_2017-06-05_v8_muscle_skeletal.gct.gz

Human fusion info from:
https://onlinelibrary.wiley.com/action/downloadSupplement?doi=10.1002%2Fpath.5053&file=path5053-sup-0001-SupInfo.pdf

## DE comparisons to make
Based on group names from sampleMetadata.xlsx

DrFusion vs DrSkMu
DrKras vs DrKrasCtrl
MmFusion vs MmSkMu
HsFusion vs HsSkMu

# Workflow

## Load libraries
```{r libraries, cache=FALSE, eval=TRUE}
library(tidyverse)
theme_set(theme_bw())
theme_update(plot.title = element_text(hjust = 0.5))
options(bitmaptype = "cairo")
library(gt)
library(edgeR)
```

## Make up directory structure
```{bash mkdirs, eval=TRUE}
for directoryName in \
  misc \
  slurmOut \
  sbatchCmds \
  input \
  output/fastqc \
  output/figures \
  output/kallisto \
  output/fusionAligned \
  output/aligned \
  output/aligned/mmSkMu/ \
  output/aligned/mmVGLL/ \
  output/aligned/Hs \
  output/aligned/drKras \
  output/aligned/drVGLL \
  output/de \
  output/geneCounts \
  output/trimmed
do
  if [ ! -d ${directoryName} ]
  then
    mkdir -p ${directoryName}
  fi 
done
```

## Upstream prep on mouse tumor data

### Run fastqc to assess data quality
```{r, echo=FALSE, cache=FALSE}
knitr::read_chunk("sbatchCmds/fastqc.sh", labels = "fastqcCode")
```
```{bash fastqcCode, eval=FALSE, cache=FALSE}
```
```{r, echo=FALSE, cache=FALSE}
knitr::read_chunk("~/scripts/splitFastqcData.pl", labels = "splitFastqCode")
```
```{perl splitFastqCode, eval=FALSE, cache=FALSE}
```
```{bash fastqc, eval=FALSE}
sbatch sbatchCmds/fastqc.sh

rm output/fastqc/*.zip

for inFile in output/fastqc/*/fastqc_data.txt
do
  perl ~/scripts/splitFastqcData.pl -i ${inFile}
done
```

#### Plot Fastqc output for all samples
```{r plotFastqc, dependson='fastqc', eval=FALSE}
adapter_file_dirs <- list.dirs(
    path = "output/fastqc",
    full.names = TRUE,
    recursive = FALSE
)

to_plot <- tibble(
    file = c(
        "Adapter_Content.txt",
        "Per_base_sequence_quality.txt"
    ),
    column = c(
        "Nextera_Transposase_Sequence",
        "Mean"
    )
)

for (i in 1:nrow(to_plot)) {
    temp_data <- NULL

    for (data_dir in adapter_file_dirs) {
        temp_data <- read_delim(paste(data_dir,
            "/split_data/",
            to_plot$file[i],
            sep = ""),
        delim = "\t",
        col_names = TRUE,
        show_col_types = FALSE) %>%
            rename_all(~ str_replace_all(., " ", "_")) %>%
            rename_all(~ str_remove(., "[#']")) %>%
            select(Base, to_plot$column[i]) %>%
            mutate(Sample = str_remove(data_dir, "_001_fastqc") %>%
                str_remove(".+\\/")) %>%
            mutate(Read = str_remove(Sample, ".+_")) %>%
            mutate(Tech = str_remove(Sample, "_.+")) %>%
            bind_rows(temp_data)
    }

    max_y <- ceiling(max(temp_data[[to_plot$column[i]]]) * 1.1)

    plot_fastqc <- ggplot(temp_data,
                          aes(x = Base,
                              y = get(to_plot$column[i]),
                              group = Sample,
                              color = Sample)) +
        geom_line() +
        geom_point() +
        facet_wrap(~Tech, ncol = 1) +
        ylim(0, max_y) +
        ylab(to_plot$column[i]) +
        theme(legend.position = "none") +
        ggtitle(str_remove(to_plot$file[i], ".txt"))

    png(
        filename = paste("output/figures/fastqc_",
            str_remove(to_plot$file[i], ".txt"),
            ".png",
            sep = ""),
        width = 7000,
        height = 3000,
        res = 300)
    print(plot_fastqc)
    dev.off()
}

input_reads <- read_tsv(list.files(path = "output/fastqc",
                                   recursive = TRUE,
                                   pattern = "Basic_Statistics.txt",
                                   full.names = TRUE),
                        id = "File",
                        show_col_types = FALSE) %>%
    filter(`#Measure` == "Total Sequences") %>%
    select(-`#Measure`) %>%
    mutate(
        File = str_remove(File, "output/fastqc/") %>%
            str_remove("_001_fastqc/split_data/Basic_Statistics.txt"),
        Sample = str_remove(File, "_S[0-9].+"),
        Lane = str_remove(File, ".+_L00") %>%
            str_remove("_R[12]"),
        Read = str_replace(File, ".+_R", "R"),
        Value = as.numeric(Value)) %>%
    rename(Reads = Value)

ggplot(input_reads, aes(x = Sample, y = Reads / 1000000, fill = Lane)) +
    geom_col() +
    facet_wrap(~Read, ncol = 1) +
    ylab("Reads (in millions)") +
    xlab("") +
    ggtitle("Sequenced Reads Per Sample") +
    theme(axis.text.x = element_text(angle = 90, hjust = 1))

ggsave("output/figures/InputReads.png",
    height = 3000,
    width = 4000,
    units = "px"
)
```

## Upstream prep on control mouse skeletal muscle data from SRA


## Got human skeletal muscle data from GTEx
https://storage.googleapis.com/gtex_analysis_v8/rna_seq_data/gene_reads/gene_reads_2017-06-05_v8_muscle_skeletal.gct.gz

Edited the file by hand to get rid of extraneous header info

## Aligning all data

### Make Mm10 reference compatible with STAR
```{bash starRef, eval=FALSE}
sbatch sbatchCmd/genStarRef.sh
```

### Make Hg38.4 reference compatible with STAR
```{bash starRef, eval=FALSE
sbatch ref/starhg38.p4/genStarRef.sh
```

### Make VGLL2NCOA2 fusion reference compatible with STAR
```{bash fusionRef, eval=FALSE}
sbatch ref/fusionRef/genStarFusionRef.sh
```

### Align mouse tumor data to the mm10 genome
```{bash align, eval=FALSE}
STAR --version

sbatch sbatchCmds/alignMmVGLL.sh
```

### Align mouse skeletal muscle data from SRA
Download from SRA
Trim adapters
Trim reads to 101bp to match mouse tumor samples
Align to Mm genome
```{bash alignMmSkMu, eval=FALSE}
sbatch sbatchCmds/alignMmSkMuscle.sh
```

### Align zebrafish P53/Kras mutant data to the zebrafish genome
```{bash alignDrKras, eval=FALSE}
sbatch sbatchCmds/alignDrKras.sh
```

### Align zebrafhish VGLL2NCOA2 samples to the zebrafish genome
```{bash alignDrVGLL2NCOA2, eval=FALSE}
sbatch sbatchCmds/alignDrVGLL.sh
```

### Align human data to the hg38.4 genome
```{bash alignHs, eval=FALSE}
sbatch sbatch/alignHs.sh
```

### Align human, mouse and zebrafish VGLL2NCOA2 tumors to the VGLL2NCOA2 fusion sequence
```{bash alignVgl, eval=FALSE}
sbatch sbatchCmds/alignFusion.sh
```

## Count the number of reads aligned per gene

### Count mouse genes
```{bash countAlignedMm, eval=FALSE}
sbatch sbatchCmds/countMmGenes.sh
```

### Count human data
```{bash countAlignedHs, eval=FALSE}
sbatch sbatchCmds/countHsGenes.sh
```

### Count zebrafish data
```{bash countAlignedDr, eval=FALSE}
sbatch sbatchCmds/countDrGenes.sh
```

### Plot percent of reads aligned
Get data from Log.final.out
```{r plotAligned, dependson='align', eval=TRUE}
grep_counts <- function(query, name) {
    system(paste0("grep '", query, "' output/aligned/*/*Log.final.out"),
           intern = TRUE) %>%
    as_tibble() %>%
    separate(col = value,
             into = c("sample", name),
             sep = "\t") %>%
    mutate(sample = str_remove(sample, "output/aligned/") %>%
                str_remove("Log.final.out.+"))
}

aligned_counts <-
    grep_counts("Number of input reads", "input_reads") %>%
    full_join(grep_counts("Uniquely mapped reads number", "mapped_reads"),
              by = "sample") %>%
    full_join(grep_counts("Uniquely mapped reads %", "perc_mapped"),
              by = "sample") %>%
    separate(col = sample,
             into = c("project", "sample"),
             sep = "/")

plot_aligned <-
    ggplot(aligned_counts, aes(x = sample,
                           y = as.numeric(mapped_reads) / as.numeric(input_reads),
                           fill = project)) +
    geom_col() +
    labs(x = "",
         y = "Proportion of reads mapped",
         title = "Proportion of Reads Aligned to the Genome") +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    scale_fill_brewer(palette = "Set2")

ggsave("output/figures/CountAligned.png",
       plot = plot_aligned,
       height = 3000,
       width = 4000,
       units = "px")
```

## Read in gene counts per sample

Remember to kick out the last few rows which have summary numbers
Columns are arranged in alphabetic order by sample, double checked this by
calculating colsums on each and comparing to output/aligned/*.final.out

Ortholog sources:

http://www.informatics.jax.org/downloads/reports/HOM_AllOrganism.rpt
https://www.genenames.org/tools/hcop/
http://www.ensembl.org/biomart/martview/
https://www.alliancegenome.org/downloads

### Merge read counts into a single table that can be used later
```{r combineGeneCounts, cache.var=FALSE, eval=TRUE}
for (species in c("Dr", "Mm", "Hs")) {
    gene_counts <- read_tsv(list.files(path = "output/geneCounts",
                                       pattern = paste0("geneCounts",
                                                        species,
                                                        ".+.txt$"),
                                       full.names = TRUE),
                            id = "sample",
                            col_names = c("gene", "count"),
                            show_col_types = FALSE) %>%
        mutate(sample = str_remove(sample,
                                   paste0("output/geneCounts/geneCounts",
                                          species,
                                          "_")) %>%
                            str_remove(".txt")) %>%
        filter(grepl("^__", gene) == FALSE) %>%
        pivot_wider(names_from = "sample",
                    values_from = "count",
                    values_fill = 0)

    # keep only genes in the counts files for human
    if (species == "Hs") {
        gene_counts <-
            inner_join(gene_counts,
                      read_tsv("input/gene_reads_2017-06-05_v8_muscle_skeletal.gct.gz",
                               show_col_types = FALSE) %>%
                select(-id, -Name) %>%
                group_by(Description) %>%
                summarize(across(where(is.numeric), sum)) %>%
                rename(gene = Description)) %>%
            mutate(across(everything(), ~replace_na(.x, 0)))
    }

    # Keep only genes that are in the tumor samples since some of the samples
    # were prepped with a different library prep method
    if (species == "Mm") {
        sk_mu <-
            gene_counts %>%
            select(c(gene, starts_with("SRR"))) %>%
            rowwise() %>%
            mutate(row_sum = sum(c_across(where(is.numeric)))) %>%
            ungroup() %>%
            filter(row_sum > 0) %>%
            select(-row_sum)

        tumor <-
            gene_counts %>%
            select(c(gene, !starts_with("SRR"))) %>%
            rowwise() %>%
            mutate(row_sum = sum(c_across(where(is.numeric)))) %>%
            ungroup() %>%
            filter(row_sum > 0) %>%
            select(-row_sum)

        gene_counts <- inner_join(tumor, sk_mu, by = "gene")
    }

    write_tsv(gene_counts, paste0("output/geneCounts/geneCountsCombined",
                                  species,
                                  ".txt.gz"))
}
```

## PCA

### PCA on each species separately
```{r pca, eval=TRUE}
metadata <- read_tsv("misc/sampleMetadata.txt",
                       show_col_types = FALSE)

for (species in c("Dr", "Mm", "Hs")) {

    gene_counts <- read_tsv(paste0("output/geneCounts/geneCountsCombined",
                                   species,
                                   ".txt.gz"),
                            show_col_types = FALSE) %>%
        column_to_rownames("gene")

    # Add GTEX data to the metadata
    if (species == "Hs") {
        metadata <- metadata %>%
            filter(!grepl("GTEX", sample)) %>%
            bind_rows(tibble(sample = colnames(gene_counts)[grep("GTEX",
                                                                 colnames(gene_counts))],
                             group = "HsSkMu",
                             bioproject = "GTEX"))
    }

    groups <- metadata[metadata %>%
                       pull(sample) %>%
                       match(colnames(gene_counts), .), ] %>%
        pull(group)

    data_dge <- DGEList(counts = gene_counts, group = groups)

    kept_df <- filterByExpr(data_dge, min.count = 0.1)

    data_dge <- data_dge[kept_df, keep.lib.sizes = FALSE] %>%
        calcNormFactors(.) %>%
        estimateDisp(., model.matrix(~ groups))

    dim(data_dge$counts)

    norm_counts <-
        cpm(data_dge) %>%
        as.data.frame() %>%
        t()

    write.table(as.data.frame(t(norm_counts)),
                file = paste0("output/geneCounts/geneCountsCombined",
                              species,
                              "_norm.txt"),
                quote = FALSE,
                sep = "\t")

    pca_out <- prcomp(norm_counts)

    pca_out_merged <-
        left_join(as.data.frame(pca_out$x) %>%
                    rownames_to_column("sample"),
                  metadata)

    variance <- (pca_out$sdev)^2 / sum(pca_out$sdev^2) * 100

    for (color_group in c("group", "bioproject")) {
        ggplot(pca_out_merged,
            aes(x = PC1,
                y = PC2,
                color = get(color_group),
                label = sample)) +
            geom_point(size = 2.5, color = "black") +
            geom_point(size = 2) +
            ggrepel::geom_text_repel(size = 2, max.overlaps = 20) +
            scale_color_brewer(palette = "Set2",
                               name = stringr::str_to_title(color_group)) +
            xlab(paste0("PC1 (",
                        round(variance[1], 1),
                        "%)")) +
            ylab(paste0("PC2 (",
                        round(variance[2], 1),
                        "%)")) +
            ggtitle(paste("PCA on", species))

        ggsave(paste0("output/figures/PCA_",
                      species,
                      "_",
                      color_group,
                      ".png"),
            height = 10,
            width = 13)

        pca_out_merged %>%
            select({{ color_group }}, paste0("PC", 1:9)) %>%
            pivot_longer(cols = -{{ color_group }},
                         names_to = "pc",
                         values_to = "pc_value") %>%
            group_by(pc) %>%
            mutate(scaled_pc_value = scale(pc_value)) %>%
            ggplot(aes(x = pc,
                       y = scaled_pc_value,
                       color = get(color_group))) +
            geom_boxplot(outlier.shape = NA) +
            geom_point(position = position_jitterdodge(jitter.width = 0.05),
                       size = 0.5) +
            scale_color_brewer(palette = "Set2",
                               name = stringr::str_to_title(color_group)) +
            ggtitle("Separation of Groups by PCs")

        ggsave(paste0("output/figures/PCA_",
                      species,
                      "_",
                      color_group,
                      "_boxplot.png"),
            height = 8,
            width = 13)
    }
}
```

### Do PCA/UMAP on just zebrafish tumors and skeletal muscle
```{r pca_zebrafish_tumors, eval=TRUE}
metadata <- read_tsv("misc/sampleMetadata.txt",
                       show_col_types = FALSE) %>%
    filter(group == "DrFusion" | group == "DrSkMu" | group == "DrKras")

gene_counts <- read_tsv(paste0("output/geneCounts/geneCountsCombinedDr.txt.gz"),
                        show_col_types = FALSE) %>%
    column_to_rownames("gene") %>%
    select(matches(metadata$sample))

groups <- metadata[metadata %>%
                    pull(sample) %>%
                    match(colnames(gene_counts), .), ] %>%
    pull(group)

data_dge <- DGEList(counts = gene_counts, group = groups)

kept_df <- filterByExpr(data_dge, min.count = 0.1)

data_dge <- data_dge[kept_df, keep.lib.sizes = FALSE] %>%
    calcNormFactors(.) %>%
    estimateDisp(., model.matrix(~ groups))

dim(data_dge$counts)

norm_counts <-
    cpm(data_dge) %>%
    as.data.frame() %>%
    t()

### Heatmaps
png("output/figures/heatmap_zebrafish_tumors.png",
    width = 2000,
    height = 2000,
    res = 300)
pheatmap::pheatmap(t(norm_counts),
                   color = colorRampPalette(rev(RColorBrewer::brewer.pal(n = 7,
                                                                         name = "PuOr")))(100),
                   show_rownames = FALSE,
                   scale = "row",
                   fontsize = 8,
                   annotation_names_col = FALSE,
                   annotation_col = data.frame(Group = groups,
                                               row.names = colnames(gene_counts)))
dev.off()

### PCA
pca_out <- prcomp(norm_counts)

pca_out_merged <-
    left_join(as.data.frame(pca_out$x) %>%
                rownames_to_column("sample"),
                metadata)

variance <- (pca_out$sdev)^2 / sum(pca_out$sdev^2) * 100

ggplot(pca_out_merged,
       aes(x = PC1,
           y = PC2,
           color = group,
           label = sample)) +
    geom_point(size = 2.5, color = "black") +
    geom_point(size = 2) +
    ggrepel::geom_text_repel(size = 2, max.overlaps = 20) +
    scale_color_brewer(palette = "Set2",
                        name = "Group") +
    xlab(paste0("PC1 (",
                round(variance[1], 1),
                "%)")) +
    ylab(paste0("PC2 (",
                round(variance[2], 1),
                "%)")) +
    ggtitle("PCA on Zebrafish Tumors")

ggsave(paste0("output/figures/PCA_Dr_tumors.png"),
    height = 10,
    width = 13)

pca_out_merged %>%
    select(group, paste0("PC", 1:9)) %>%
    pivot_longer(cols = -group,
                    names_to = "pc",
                    values_to = "pc_value") %>%
    group_by(pc) %>%
    mutate(scaled_pc_value = scale(pc_value)) %>%
    ggplot(aes(x = pc,
                y = scaled_pc_value,
                color = group)) +
    geom_boxplot(outlier.shape = NA) +
    geom_point(position = position_jitterdodge(jitter.width = 0.05),
                size = 0.5) +
    scale_color_brewer(palette = "Set2",
                        name = stringr::str_to_title(color_group)) +
    ggtitle("Separation of Groups by PCs")

ggsave(paste0("output/figures/PCA_Dr_boxplot.png"),
    height = 8,
    width = 13)

set.seed(1337)
umap_out <- umap::umap(norm_counts, n_neighbors = 4)$layout %>%
    as.data.frame() %>%
    rownames_to_column("sample") %>%
    as_tibble() %>%
    left_join(metadata)

centroids <- umap_out %>%
    group_by(group) %>%
    summarize(V1 = mean(V1),
              V2 = mean(V2),
              .groups = "drop")

ggplot(umap_out,
        aes(x = V1,
            y = V2,
            color = group)) +
    geom_point(size = 4) +
    ggrepel::geom_text_repel(data = centroids,
                             aes(x = V1,
                                 y = V2,
                                 label = group),
                             color = "black",
                             force = 50) +
    scale_color_brewer(palette = "Paired",
                        name = "Group") +
    ggrepel::geom_text_repel(aes(label = sample))

ggsave(paste0("output/figures/umap_Dr_tumors_groups.png"),
    height = 8,
    width = 15)
```


### Merged species PCA
Show human and mouse samples in PCA and make heatmap of 27 genes of interest
```{r mergedPCA, eval=TRUE}
species_full <- list(Hs = "Homo sapiens",
                     Mm = "Mus musculus",
                     Dr = "Danio rerio")

merged_data <- tibble(Dr = character())

for (species in c("Dr", "Mm", "Hs")) {
    gene_counts <- read_tsv(paste0("output/geneCounts/geneCountsCombined",
                                   species,
                                   ".txt.gz"),
                            show_col_types = FALSE) %>%
        rename({{ species }} := gene)

    if (species != "Dr") {
        gene_counts <- right_join(read_tsv("../refs/ORTHOLOGY-ALLIANCE_COMBINED.tsv.gz",
                                           show_col_types = FALSE,
                                           comment = "#") %>%
            dplyr::filter(Gene1SpeciesName == species_full[["Dr"]] &
                          Gene2SpeciesName == species_full[[species]]) %>%
            select(Gene1Symbol, Gene2Symbol) %>%
            rename(Dr = Gene1Symbol,
                   {{ species }} := Gene2Symbol) %>%
            distinct(),
                                  gene_counts)
    } else {
        gene_counts <- right_join(read_tsv("/home/gdkendalllab/lab/references/annotations/zebrafish_gene_info.txt.gz",
                                           show_col_types = FALSE,
                                           comment = "#") %>%
                select(Gene_name, Gene_stable_ID_version) %>%
                rename(Dr = Gene_stable_ID_version) %>%
                distinct(),
                                  gene_counts) %>%
            select(-Dr) %>%
            rename(Dr = Gene_name) %>%
            filter(!is.na(Dr)) %>%
            group_by(Dr) %>%
            summarize(across(where(is.numeric), sum), .groups = "drop")
    }

    merged_data <- full_join(merged_data, gene_counts) %>%
        na.omit()
}

merged_data <-
    merged_data %>%
    mutate(gene = paste(Dr, Mm, Hs, sep = "/")) %>%
    select(-Mm, -Hs, -Dr) %>%
    column_to_rownames("gene")

metadata <-
    read_tsv("misc/sampleMetadata.txt",
                       show_col_types = FALSE) %>%
    select(sample, group) %>%
    filter(!grepl("GTEX", sample)) %>%
    bind_rows(tibble(sample = colnames(gene_counts)[grep("GTEX",
                                                            colnames(gene_counts))],
                        group = "HsSkMu",
                        bioproject = "GTEX")) %>%
    arrange(match(sample, colnames(merged_data))) %>%
    mutate(species = substr(group, 1, 2))

metadata <-
    metadata[metadata %>%
        pull(sample) %>%
        match(colnames(merged_data), .), ]

groups <- metadata$group

data_dge <- DGEList(counts = merged_data, group = groups)

kept_df <- filterByExpr(data_dge, min.count = 0.1)

data_dge <- data_dge[kept_df, keep.lib.sizes = FALSE] %>%
    calcNormFactors(.) %>%
    estimateDisp(., model.matrix(~ groups))

dim(data_dge$counts)

norm_counts <-
    cpm(data_dge) %>%
    as.data.frame() %>%
    t()

### Heatmaps
set.seed(1337)
non_gtex_samples <- grep("GTEX", rownames(norm_counts), invert = TRUE)
gtex_samples_20 <- grep("GTEX", rownames(norm_counts)) %>%
    sample(size = 20)
sub_gtex <- norm_counts[c(non_gtex_samples, gtex_samples_20), ]

annot_df <-  data.frame(Group = groups[c(non_gtex_samples, gtex_samples_20)],
                        row.names = colnames(merged_data)[c(non_gtex_samples, gtex_samples_20)]) %>%
    mutate(Species = substr(Group, 1, 2))

png("output/figures/heatmap_all.png",
    width = 3500,
    height = 2000,
    res = 300)
pheatmap::pheatmap(t(sub_gtex),
                   color = colorRampPalette(rev(RColorBrewer::brewer.pal(n = 7,
                                                                         name = "PuOr")))(100),
                   show_rownames = FALSE,
                   scale = "row",
                   fontsize = 8,
                   annotation_names_col = FALSE,
                   annotation_col = annot_df)
dev.off()

### PCA
pca_out <- prcomp(norm_counts)

pca_out_merged <-
    left_join(as.data.frame(pca_out$x) %>%
                rownames_to_column("sample"),
                metadata)

variance <- (pca_out$sdev)^2 / sum(pca_out$sdev^2) * 100

ggplot(pca_out_merged,
    aes(x = PC1,
        y = PC2,
        color = group)) +
    geom_point(size = 2.5, color = "black") +
    geom_point(size = 2) +
    scale_color_brewer(palette = "Paired",
                        name = "Group") +
    xlab(paste0("PC1 (",
                round(variance[1], 1),
                "%)")) +
    ylab(paste0("PC2 (",
                round(variance[2], 1),
                "%)")) +
    ggtitle(paste("PCA on", species))

ggsave(paste0("output/figures/PCA_all_groups.png"),
    height = 10,
    width = 13)

pca_out_merged %>%
    select(group, paste0("PC", 1:9)) %>%
    pivot_longer(cols = -group,
                 names_to = "pc",
                 values_to = "pc_value") %>%
    group_by(pc) %>%
    mutate(scaled_pc_value = scale(pc_value)) %>%
    ggplot(aes(x = pc,
               y = scaled_pc_value,
               color = group)) +
    geom_boxplot(outlier.shape = NA) +
    geom_point(position = position_jitterdodge(jitter.width = 0.05),
               size = 0.2) +
    scale_color_brewer(palette = "Paired",
                       name = "Group") +
    ggtitle("Separation of Groups by PCs")

ggsave(paste0("output/figures/PCA_all_boxplot.png"),
    height = 8,
    width = 13)

set.seed(1337)
sub_gtex_Mm_Hs <-
    sub_gtex[rownames(sub_gtex) %in% (metadata %>%
                        filter(species == "Hs" | species == "Mm") %>%
                        pull(sample)), ]

umap_out <- umap::umap(sub_gtex_Mm_Hs)$layout %>%
    as.data.frame() %>%
    rownames_to_column("sample") %>%
    as_tibble() %>%
    left_join(metadata %>%
                mutate(group = str_replace(group,
                                           "^HsFusion$",
                                           "Human VGLL2NCOA2 Tumors") %>%
                               str_replace("^HsSkMu$",
                                           "Human Skeletal Muscle") %>%
                               str_replace("^MmFusion$",
                                           "Mouse VGLL2NCOA2 Tumors") %>%
                               str_replace("^MmSkMu$",
                                           "Mouse Skeletal Muscle") %>%
                               str_replace("^MmFusionControl$",
                                           "Mouse VGLL2NCOA2 Control")))

centroids <- umap_out %>%
    group_by(group) %>%
    summarize(V1 = mean(V1),
              V2 = mean(V2),
              .groups = "drop")

ggplot(umap_out,
        aes(x = V1,
            y = V2,
            color = group)) +
    geom_point(alpha = 0.9, size = 2) +
    ggrepel::geom_text_repel(data = centroids,
                             aes(x = V1,
                                 y = V2,
                                 label = group),
                             color = "black",
                             force = 50) +
    scale_color_brewer(palette = "Paired",
                       name = "Group")

ggsave(paste0("output/figures/umap_Mm_Hs.png"),
    height = 8,
    width = 15)
```

## Run DE

Needed:
DrFusion vs DrSkMu
DrKras vs DrKrasCtrl
MmFusion vs MmSkMu
HsFusion vs HsSkMu
```{r de, eval=TRUE}
metadata <- read_tsv("misc/sampleMetadata.txt",
                       show_col_types = FALSE)

de_cmp_table <- tibble(group_1 = c("DrSkMu", "DrKrasCtrl", "MmSkMu", "HsSkMu"),
                       group_2 = c("DrFusion", "DrKras", "MmFusion", "HsFusion"))

logFC_plot_list <- list()
volcano_plot_list <- list()
scatterplot_list <- list()

for (i in seq_len(nrow(de_cmp_table))) {
## EdgeR portion
    species <- substr(de_cmp_table[i, "group_1"], 1, 2)
    count_data <- read_tsv(paste0("output/geneCounts/geneCountsCombined",
                                  species,
                                  ".txt.gz"),
                           show_col_types = FALSE)

    if (species == "Hs") {
        metadata <- metadata %>%
            filter(!grepl("GTEX", sample)) %>%
            bind_rows(tibble(sample = colnames(count_data)[grep("GTEX",
                                                                 colnames(count_data))],
                             group = "HsSkMu",
                             bioproject = "GTEX"))
    }

    # swap out gene stable ID for gene name and sum each gene across samples
    if (species == "Dr") {
        count_data <-
            inner_join(count_data,
                       read_tsv("/home/gdkendalllab/lab/references/annotations/zebrafish_gene_info.txt.gz",
                               show_col_types = FALSE,
                               col_select = c("Gene_stable_ID_version",
                                              "Gene_name")) %>%
                        mutate(gene = Gene_stable_ID_version) %>%
                        select(-Gene_stable_ID_version) %>%
                        distinct() %>%
                        na.omit()) %>%
            mutate(gene = Gene_name) %>%
            select(-Gene_name) %>%
            group_by(gene) %>%
            summarize(across(where(is.numeric), sum), .groups = "drop")
    }

    # Make MmFusionControl part of MmSkMu so these samples are included in the DE analysis
    if (species == "Mm") {
        metadata$group[metadata$group == "MmFusionControl"] <- "MmSkMu"
    }

    group_1_samples <- metadata$sample[metadata$group %in%
                                        de_cmp_table$group_1[i]]
    group_2_samples <- metadata$sample[metadata$group %in%
                                        de_cmp_table$group_2[i]]

    count_data <- count_data[, match(c("gene",
                                        group_1_samples,
                                        group_2_samples),
                                      colnames(count_data))] %>%
        column_to_rownames("gene")

    groups <- factor(c(rep(de_cmp_table$group_1[i], length(group_1_samples)),
                       rep(de_cmp_table$group_2[i], length(group_2_samples))),
                     levels = c(de_cmp_table$group_1[i], de_cmp_table$group_2[i]))

    saveRDS(groups, file = paste0("output/de/",
                               de_cmp_table$group_1[i],
                               "_",
                               de_cmp_table$group_2[i],
                               "_groups.rds"))

    data_dge <- DGEList(counts = count_data, group = groups)

    kept_df <- filterByExpr(data_dge, min.count = 0.1)

    data_dge <- data_dge[kept_df, keep.lib.sizes = FALSE] %>%
        calcNormFactors(.) %>%
        estimateDisp(., model.matrix(~ groups))

    dim(data_dge$counts)

    tested <- exactTest(data_dge)

    results <- topTags(tested, n = Inf)
    results$table$Gene <- rownames(results$table)

    summarized_data <- cpm(data_dge) %>%
        as.data.frame() %>%
        rownames_to_column(var = "Gene") %>%
        as_tibble() %>%
        full_join(cpmByGroup(data_dge) %>%
            as.data.frame() %>%
            rename_all(~ str_c(.x, "_mean")) %>%
            rownames_to_column("Gene") %>%
            as_tibble(),
            by = "Gene") %>%
        full_join(results$table, by = "Gene") %>%
        rowwise() %>%
        mutate(signif = FDR <= 0.1)

    # add in zebrafish gene annotations
    if (species == "Dr") {
        summarized_data <-
            inner_join(summarized_data,
                       read_tsv("/home/gdkendalllab/lab/references/annotations/zebrafish_gene_info.txt.gz",
                                show_col_types = FALSE,
                                col_select = c("Gene_stable_ID",
                                               "Gene_name")) %>%
                       mutate(Gene = Gene_name) %>%
                       distinct()) %>%
                mutate(Gene = Gene_name) %>%
                select(-Gene_name) %>%
                group_by(Gene) %>%
                distinct()
    }

    write_tsv(summarized_data, paste0("output/de/",
                                      de_cmp_table$group_1[i],
                                      "_",
                                      de_cmp_table$group_2[i],
                                      "_edgeR.txt"))

    ## Plots
    ### LogFC
    logFC_plot_list[[i]] <-
        ggplot(results$table, aes(x = logFC)) +
        geom_histogram(bins = 300) +
        ggtitle(paste0(de_cmp_table$group_1[i],
                       " vs ",
                       de_cmp_table$group_2[i],
                       " logFC Histogram"))

    names(logFC_plot_list)[i] <- paste(de_cmp_table$group_1[i],
                                       "vs",
                                       de_cmp_table$group_2[i])

    ggsave(paste0("output/figures/logFC_histogram_",
                    de_cmp_table$group_1[i],
                    "_",
                    de_cmp_table$group_2[i],
                    ".png"),
           logFC_plot_list[[i]],
           width = 6,
           height = 6)

    x_mean_colname <- paste0(de_cmp_table$group_1[i], "_mean")
    y_mean_colname <- paste0(de_cmp_table$group_2[i], "_mean")

    x_max <- (max(summarized_data[[x_mean_colname]]) / 1000)  %>%
                ceiling() * 1000
    y_max <- (max(summarized_data[[y_mean_colname]]) / 1000)  %>%
                ceiling() * 1000

    ### Scatterplot
    # Using "local" here because the variable x_mean_colname in the plot list
    # uses only the final value outside of the loop
    scatterplot_list[[i]] <-
        local({
            x_mean_colname <- x_mean_colname
            y_mean_colname <- y_mean_colname
            x_max <- x_max
            y_max <- y_max

            ggplot(summarized_data,
            aes(x = get(x_mean_colname),
                y = get(y_mean_colname))) +
            geom_line(data = tibble({{ x_mean_colname }} := c(0, x_max),
                                    {{ y_mean_colname }} := c(0, y_max)),
                      color = "red") +
            geom_point(alpha = 0.5, size = 0.5) +
            scale_x_log10() +
            scale_y_log10() +
            labs(x = paste0(de_cmp_table$group_1[i], " mean"),
                 y = paste0(de_cmp_table$group_2[i], " mean"),
                 title = paste0(de_cmp_table$group_1[i],
                                " vs ",
                                de_cmp_table$group_2[i],
                                " Scatterplot"))
        })

    names(scatterplot_list)[i] <- paste(de_cmp_table$group_1[i],
                                        "vs",
                                        de_cmp_table$group_2[i])

    ggsave(paste0("output/figures/scatterplot_",
                    de_cmp_table$group_1[i],
                    "_",
                    de_cmp_table$group_2[i],
                    ".png"),
           scatterplot_list[[i]],
           width = 6,
           height = 6)

    ### Volcano
    volcano_plot_list[[i]] <-
        ggplot(summarized_data, aes(x = logFC,
                                    y = -log10(PValue),
                                    color = signif)) +
        geom_point(alpha = 0.1) +
        scale_color_brewer(palette = "Set2", name = "Signif.") +
        labs(y = "-log10(p-value)",
             title = paste0(de_cmp_table$group_1[i],
                            " vs ",
                            de_cmp_table$group_2[i],
                            " Volcano Plot"))

    names(volcano_plot_list)[[i]] <- paste(de_cmp_table$group_1[i],
                                         "vs",
                                         de_cmp_table$group_2[i])

    ggsave(paste0("output/figures/volcano_plot_",
                    de_cmp_table$group_1[i],
                    "_",
                    de_cmp_table$group_2[i],
                    ".png"),
           volcano_plot_list[[i]],
           width = 10,
           height = 6)
}
```

### GSEA on individual DE datasets
```{r gsea, eval=TRUE}
species_full <- list(Hs = "Homo sapiens",
                     Dr = "Danio rerio",
                     Mm = "Mus musculus")

orgdb_list <- list(Hs = org.Hs.eg.db::org.Hs.eg.db,
                   Dr = org.Dr.eg.db::org.Dr.eg.db,
                   Mm = org.Mm.eg.db::org.Mm.eg.db)

gsea_df <- tibble()
for (de_file in list.files(path = "output/de",
                           pattern = "_edgeR.txt",
                           full.names = TRUE)) {

    species <- de_file %>%
            str_remove(".+\\/") %>%
            substr(0, 2)

    species_name <- species_full[[species]]

    cmp_name <-
        de_file %>%
        str_remove(".+\\/") %>%
        str_remove("_edgeR.txt")

    de_data <-
        read_tsv(de_file,
                 col_select = c("Gene", "logFC"),
                 show_col_types = FALSE) %>%
        arrange(-1 * logFC) %>%
        distinct() %>%
        pull(logFC, name = Gene)

    set.seed(1337)
    gsea_out <- clusterProfiler::gseGO(geneList = de_data,
                                       OrgDb = orgdb_list[[species]],
                                       ont = "ALL",
                                       keyType = "SYMBOL")

    write_tsv(as.data.frame(gsea_out),
              file = paste0("output/gsea/gsea_",
                            de_file %>%
                                str_remove(".+\\/") %>%
                                str_remove("_edgeR.txt"),
                            "_out.txt"))

    # GSEA plots for top 10 up/down
    top_up_down <-
        as.data.frame(gsea_out) %>%
        as_tibble() %>%
        mutate(order = seq_len(n()),
               group = if_else(NES > 0, "up", "down")) %>%
        filter(p.adjust <= 0.05) %>%
        select(enrichmentScore,
               order,
               p.adjust,
               NES,
               group,
               ONTOLOGY,
               Description) %>%
        group_by(ONTOLOGY, group) %>%
        arrange(p.adjust, abs(NES) * -1, .by_group = TRUE) %>%
        slice_head(n = 10) %>%
        ungroup()
    pdf(paste0("output/figures/",
               cmp_name,
               "_gseaPlots.pdf"))
    for (i in seq_len(nrow(top_up_down))) {
        print(clusterProfiler::gseaplot(
            gsea_out,
            by = "runningScore",
            geneSetID = top_up_down$order[i],
            title = paste0(top_up_down$ONTOLOGY[i],
                           ": ",
                           top_up_down$Description[i],
                           "\nNES: ",
                           round(top_up_down$NES[i], digits = 2),
                           ", p=",
                           sprintf("%.2e", top_up_down$p.adjust[i]))))
    }
    dev.off()

    as.data.frame(gsea_out) %>%
        as_tibble() %>%
        filter(!is.na(ONTOLOGY)) %>%
        group_by(ONTOLOGY, NES > 0) %>%
        slice_head(n = 10) %>%
        mutate(desc_wrapped = str_wrap(Description, width = 25) %>%
                    fct_reorder(NES)) %>%
        ggplot(aes(x = NES, y = desc_wrapped, fill = NES)) +
        geom_col() +
        facet_wrap(~ ONTOLOGY, nrow = 1, scales = "free") +
        scale_fill_gradient2(low = "#4575b4",
                             mid = "#ffffbf",
                             high = "#d73027") +
        labs(y = "",
             title = cmp_name %>%
                str_replace(paste0("_", species), " vs ") %>%
                str_replace(species, paste0(species, " ")))

    ggsave(paste0("output/figures/GSEA_",
                  cmp_name,
                  "_top.png"),
           width = 15,
           height = 8)

    gsea_df <- bind_rows(gsea_df,
                         as.data.frame(gsea_out) %>%
        as_tibble() %>%
        filter(!is.na(ONTOLOGY)) %>%
        mutate(comp = cmp_name %>%
                str_replace(paste0("_", species), " vs ") %>%
                str_replace(species, paste0(species, " "))))
}

top_desc <-
    gsea_df %>%
    group_by(ONTOLOGY, comp, NES > 0) %>%
    slice_head(n = 4) %>%
    pull(Description) %>%
    unique()

gsea_df %>%
    filter(Description %in% top_desc & p.adjust <= 0.05) %>%
    mutate(desc_wrapped = str_wrap(Description, width = 35) %>%
            fct_reorder(NES)) %>%
    ggplot(aes(x = comp, y = desc_wrapped, fill = NES)) +
    geom_tile() +
    scale_fill_gradient2(low = "#4575b4",
                        mid = "#ffffbf",
                        high = "#d73027") +
    facet_wrap(~ ONTOLOGY,
               nrow = 1,
               scales = "free") +
    labs(x = "",
         y = "",
         title = "GSEA Results") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggsave("output/figures/GSEA_combined_tile.png",
       width = 15,
       height = 12)

edgeR_file <- list()
edgeR_file[["Dr SkMu vs Fusion"]] <- "output/de/DrSkMu_DrFusion_edgeR.txt"
edgeR_file[["Dr KrasCtrl vs Kras"]] <- "output/de/DrKrasCtrl_DrKras_edgeR.txt"
replace_list <- list("SRR6507300" = "whole_fish_1",
                     "SRR6507301" = "whole_fish_2",
                     "SRR6507302" = "whole_fish_3",
                     "SRR6507311" = "mutant_1",
                     "SRR6507312" = "mutant_2",
                     "SRR6507313" = "mutant_3")

for (comparison in c("Dr SkMu vs Fusion", "Dr KrasCtrl vs Kras")) {
    target_genes <-
        gsea_df %>%
        filter(Description == "muscle cell differentiation" &
            comp == comparison) %>%
            pull(core_enrichment) %>%
            str_split(pattern = "/") %>%
            unlist()

    temp_df <-
        read_tsv(edgeR_file[[comparison]],
            show_col_types = FALSE) %>%
        filter(Gene %in% target_genes) %>%
        select(-matches("mean"),
               -logFC,
               -logCPM,
               -PValue,
               -FDR,
               -signif,
               -Gene_stable_ID) %>%
        distinct() %>%
        column_to_rownames("Gene") %>%
        as.matrix()

    if (comparison == "Dr KrasCtrl vs Kras") {
        colnames(temp_df) <-
            replace_list[colnames(temp_df)] %>%
            unlist()
    }

    pheatmap::pheatmap(temp_df,
                       scale = "row",
                       main = "Dr Fusion Muscle Development Gene Expression",
                       filename = paste0("output/figures/GSEA_valid_",
                                         comparison,
                                         "_MuscleDiff.png"),
                       width = 10,
                       height = 14)
}
```

### IPA pathway analysis
Ran IPA on DE results. Used a FC threshold of +/- 2 and FDR of 0.1
```{r ipaPlotting, eval=TRUE}
num_paths = 10

pw_data <-
    read_tsv(list.files(path = "output/ipa",
                        pattern = "CanonicalPathways.txt",
                        full.names = TRUE),
             id = "sample") %>%
    mutate(sample = str_remove(sample, ".+/") %>%
            str_remove("_CanonicalPathways.txt")) %>%
    rename(pathway = `Ingenuity Canonical Pathways`,
           pval = `-log(p-value)`,
           z_score = `z-score`) %>%
    select(-Molecules) %>%
    filter(z_score != "NaN" & pval >= 3) %>%
    mutate(p_number = 2^(-1 * pval) %>%
           sprintf("%.2e", .),
           new_label = str_wrap(pathway, width = 40))

pw_list <-
    pw_data %>%
    group_by(sample) %>%
    arrange(pval, .by_group = TRUE) %>%
    slice_head(n = num_paths) %>%
    ungroup() %>%
    pull(pathway) %>%
    unique()


pw_data %>%
    filter(pathway %in% pw_list & pval >= -log2(0.05)) %>%
    ggplot(aes(x = sample,
               y = new_label,
               fill = as.numeric(z_score),
               label = paste0("p=", p_number, ", z=", z_score))) +
    geom_tile(width = 0.8, height = 0.8, size = 1) +
    scale_fill_gradient2(low = "#313695",
                         mid = "#ffffbf",
                         high = "#a50026",
                         name = "Z-score") +
    geom_text() +
    theme(legend.position = "none") +
    labs(x = "",
         y = "",
         title = "Enriched Pathways") +
    scale_y_discrete(limits = rev)

ggsave("output/figures/ipa_can_path.png",
       width = 12,
       height = 8)

png("output/figures/ipa_can_path_venn.png",
    width = 3000,
    height = 3000,
    res = 300)
pw_data %>%
    select(sample, pathway) %>%
    mutate(in_group = TRUE) %>%
    pivot_wider(names_from = sample,
                values_from = in_group,
                id_cols = pathway) %>%
    mutate(across(everything(), ~replace_na(.x, FALSE))) %>%
    ggplot(aes(A = DrControl_Kras,
               B = DrSkMu_Fusion,
               C = HsSkMu_Fusion,
               D = MmSkMu_Fusion)) +
    ggvenn::geom_venn(set_name_size = 4) +
    theme_void() +
    ggtitle("Canonical Pathways")
dev.off()

################################################################################
### upstream regulators

up_data <-
    read_tsv(list.files(path = "output/ipa",
                        pattern = "UpstreamRegulators.txt",
                        full.names = TRUE),
             id = "sample") %>%
    mutate(sample = str_remove(sample, ".+/") %>%
            str_remove("_UpstreamRegulators.txt")) %>%
    rename(up_reg = `Upstream Regulator`,
           mol_type = `Molecule Type`,
           z_score = `Activation z-score`,
           p_val = `p-value of overlap`) %>%
    filter(grepl("chemical|other|microRNA|other", mol_type) == FALSE) %>%
    select(-mol_type) %>%
    filter(p_val <= 0.05 & !is.na(z_score)) %>%
    mutate(new_label = str_wrap(up_reg, width = 30))

up_list <-
    up_data %>%
    group_by(sample) %>%
    arrange(p_val * -1) %>%
    slice_head(n = num_paths) %>%
    ungroup() %>%
    pull(up_reg) %>%
    unique()

up_data %>%
    filter(up_reg %in% up_list & p_val <= 0.05) %>%
    ggplot(aes(x = sample,
               y = new_label,
               fill = as.numeric(z_score),
               label = paste0("p=", sprintf("%.2e", p_val), ", z=", z_score))) +
    geom_tile(width = 0.8, height = 0.8, size = 1) +
    scale_fill_gradient2(low = "#313695",
                         mid = "#ffffbf",
                         high = "#a50026",
                         name = "Z-score") +
    geom_text() +
    theme(legend.position = "none") +
    labs(x = "",
         y = "",
         title = "Upstream Regulator") +
    scale_y_discrete(limits = rev)

ggsave("output/figures/ipa_upstream_reg.png",
       width = 12,
       height = 10)

png("output/figures/ipa_upstream_reg_venn.png",
    width = 3000,
    height = 3000,
    res = 300)
up_data %>%
    select(sample, up_reg) %>%
    mutate(in_group = TRUE) %>%
    pivot_wider(names_from = sample,
                values_from = in_group,
                id_cols = up_reg) %>%
    mutate(across(everything(), ~replace_na(.x, FALSE))) %>%
    ggplot(aes(A = DrControl_Kras,
               B = DrSkMu_Fusion,
               C = HsSkMu_Fusion,
               D = MmSkMu_Fusion)) +
    ggvenn::geom_venn(set_name_size = 4) +
    theme_void() +
    ggtitle("Upstream Regulators")
dev.off()
```

### Jointly DE genes
Make up files to use for IPA
```{r joinGSEA, eval=TRUE}
orthologs <- read_tsv("../refs/ORTHOLOGY-ALLIANCE_COMBINED.tsv.gz",
                      show_col_types = FALSE,
                      comment = "#") %>%
    filter(Gene2SpeciesName == "Danio rerio" &
           Gene1SpeciesName == "Mus musculus") %>%
    rename(mm_gene = Gene1Symbol,
           dr_gene = Gene2Symbol) %>%
    select(mm_gene, dr_gene) %>%
    distinct() %>%
    full_join(read_tsv("../refs/ORTHOLOGY-ALLIANCE_COMBINED.tsv.gz",
                        show_col_types = FALSE,
                        comment = "#") %>%
        filter(Gene2SpeciesName == "Danio rerio" &
               Gene1SpeciesName == "Homo sapiens") %>%
        rename(hs_gene = Gene1Symbol,
               dr_gene = Gene2Symbol) %>%
        select(hs_gene,dr_gene) %>%
        distinct())

# Get 
summarized_data <-
    read_tsv("output/de/DrSkMu_DrFusion_edgeR.txt",
             show_col_types = FALSE) %>%
    rename(dr_gene = Gene,
           dr_gene_id = Gene_stable_ID,
           dr_logfc = logFC,
           dr_signif = signif,
           dr_fdr = FDR) %>%
    select(dr_gene,
           dr_gene_id,
           dr_logfc,
           dr_signif,
           dr_fdr,
           DrFusion_mean,
           DrSkMu_mean) %>%
    distinct() %>%
    left_join(read_tsv("output/de/MmSkMu_MmFusion_edgeR.txt",
                       show_col_types = FALSE) %>%
        rename(mm_gene = Gene,
               mm_logfc = logFC,
               mm_signif = signif,
               mm_fdr = FDR) %>%
        select(mm_gene,
               mm_logfc,
               mm_signif,
               mm_fdr,
               MmFusion_mean,
               MmSkMu_mean) %>%
        full_join(orthologs %>%
                  select(mm_gene, dr_gene)) %>%
        filter(!is.na(dr_gene)) %>%
        distinct()) %>%
    left_join(read_tsv("output/de/HsSkMu_HsFusion_edgeR.txt",
                       show_col_types = FALSE) %>%
        rename(hs_gene = Gene,
               hs_logfc = logFC,
               hs_signif = signif,
               hs_fdr = FDR) %>%
        select(hs_gene,
               hs_logfc,
               hs_signif,
               hs_fdr,
               HsFusion_mean,
               HsSkMu_mean) %>%
        full_join(orthologs %>%
                  select(hs_gene, dr_gene)) %>%
        filter(!is.na(dr_gene)) %>%
        distinct()) %>%
    distinct()

# Write out table for IPA to use
summarized_data %>%
    select(dr_gene, dr_gene_id, dr_logfc, dr_fdr, mm_gene, mm_logfc, mm_fdr) %>%
    distinct() %>%
    na.omit() %>%
    write_tsv("output/de/merged_species_table_Dr_Mm.txt")

summarized_data %>%
    select(dr_gene, dr_gene_id, dr_logfc, dr_fdr, hs_gene, hs_logfc, hs_fdr) %>%
    distinct() %>%
    na.omit() %>%
    write_tsv("output/de/merged_species_table_Dr_Hs.txt")

summarized_data %>%
    select(mm_gene, mm_gene, mm_logfc, mm_fdr, hs_gene, hs_logfc, hs_fdr) %>%
    distinct() %>%
    na.omit() %>%
    write_tsv("output/de/merged_species_table_Mm_Hs.txt")
```

### Joint GSEA
```{r jointGSEA, eval=TRUE}
orgdb_list <- list(Hs = org.Hs.eg.db::org.Hs.eg.db,
                   Mm = org.Mm.eg.db::org.Mm.eg.db)

gsea_df <- tibble()
for (de_file in list.files(path = "output/de",
                           pattern = "merged_species_table",
                           full.names = TRUE)) {

    species_1 <-
        de_file %>%
        str_remove(".+table_") %>%
        str_remove("_.+") %>%
        str_to_lower()

    species_2 <-
        de_file %>%
        str_remove(".+_") %>%
        str_remove(".txt") %>%
        str_to_lower()

    comparison <-
        de_file %>%
        str_remove(".+table_") %>%
        str_remove(".txt")

    de_data <-
        read_tsv(de_file,
                 show_col_types = FALSE) %>%
        select(matches("gene$"),
               matches("_logfc"),
               matches("_fdr")) %>%
        distinct() %>%
        na.omit() %>%
        rename(other_logfc = paste0(species_2, "_logfc"),
               other_fdr = paste0(species_2, "_fdr"),
               other_gene = paste0(species_2, "_gene")) %>%
        filter(abs(get(paste0(species_1, "_logfc"))) >= 1 &
                abs(other_logfc) >= 1 &
                get(paste0(species_1, "_fdr")) <= 0.1 &
                other_fdr <= 0.1) %>%
        arrange(-1 * other_logfc) %>%
        distinct() %>%
        select(other_gene, other_logfc) %>%
        distinct() %>%
        pull(other_logfc, name = other_gene)

    set.seed(1337)
    gsea_out <- clusterProfiler::gseGO(geneList = de_data,
                                       OrgDb = orgdb_list[[str_to_title(species_2)]],
                                       ont = "ALL",
                                       keyType = "SYMBOL")

    write_tsv(as.data.frame(gsea_out),
              file = paste0("output/gsea/gsea_co_DE_",
                            comparison,
                            "_out.txt"))

    as.data.frame(gsea_out) %>%
        as_tibble() %>%
        filter(!is.na(ONTOLOGY)) %>%
        group_by(ONTOLOGY, NES > 0) %>%
        slice_head(n = 10) %>%
        mutate(desc_wrapped = str_wrap(Description, width = 25) %>%
                    fct_reorder(NES)) %>%
        ggplot(aes(x = NES, y = desc_wrapped, fill = NES)) +
        geom_col() +
        facet_wrap(~ ONTOLOGY, nrow = 1, scales = "free") +
        scale_fill_gradient2(low = "#4575b4",
                             mid = "#ffffbf",
                             high = "#d73027") +
        labs(y = "",
             title = comparison %>%
                str_replace("_", " co-DE with "))

    ggsave(paste0("output/figures/GSEA_co_de_",
                  comparison,
                  "_top.png"),
           width = 15,
           height = 8)

    gsea_df <- bind_rows(gsea_df,
                         as.data.frame(gsea_out) %>%
        as_tibble() %>%
        filter(!is.na(ONTOLOGY)) %>%
        mutate(comp = comparison))
}

top_desc <-
    gsea_df %>%
    group_by(ONTOLOGY, comp, NES > 0) %>%
    slice_head(n = 4) %>%
    pull(Description) %>%
    unique()

gsea_df %>%
    filter(Description %in% top_desc & p.adjust <= 0.05) %>%
    mutate(desc_wrapped = str_wrap(Description, width = 35) %>%
            fct_reorder(NES)) %>%
    ggplot(aes(x = comp %>% str_replace("_", " co-DE with "),
               y = desc_wrapped,
               fill = NES)) +
    geom_tile() +
    scale_fill_gradient2(low = "#4575b4",
                        mid = "#ffffbf",
                        high = "#d73027") +
    facet_wrap(~ ONTOLOGY,
               nrow = 1,
               scales = "free") +
    labs(x = "",
         y = "",
         title = "GSEA Results") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggsave("output/figures/GSEA_co_DE_combined_tile.png",
       width = 15,
       height = 12)

top_desc_no_mouse <-
    gsea_df %>%
    filter(comp != "Mm_Hs") %>%
    group_by(ONTOLOGY, comp, NES > 0) %>%
    slice_head(n = 4) %>%
    pull(Description) %>%
    unique()

gsea_df %>%
    filter(Description %in% top_desc_no_mouse &
            p.adjust <= 0.05 &
            comp != "Mm_Hs") %>%
    mutate(desc_wrapped = str_wrap(Description, width = 35) %>%
            fct_reorder(NES)) %>%
    ggplot(aes(x = comp %>% str_replace("_", " co-DE with "),
               y = desc_wrapped,
               fill = NES)) +
    geom_tile() +
    scale_fill_gradient2(low = "#4575b4",
                        mid = "#ffffbf",
                        high = "#d73027") +
    facet_wrap(~ ONTOLOGY,
               nrow = 1,
               scales = "free") +
    labs(x = "",
         y = "",
         title = "GSEA Results") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggsave("output/figures/GSEA_co_DE_combined_tile_no_mouse.png",
       width = 15,
       height = 12)
```

## Compare our zebrafish data to other datasets
```{r cmpMouseFish, eval=TRUE}
orthologs <-
    read_tsv("../refs/ORTHOLOGY-ALLIANCE_COMBINED.tsv.gz",
                      show_col_types = FALSE,
                      comment = "#") %>%
    filter(Gene2SpeciesName == "Danio rerio" &
           Gene1SpeciesName == "Mus musculus") %>%
    rename(mm_gene = Gene1Symbol,
           dr_gene = Gene2Symbol) %>%
    select(mm_gene, dr_gene) %>%
    distinct() %>%
    full_join(read_tsv("../refs/ORTHOLOGY-ALLIANCE_COMBINED.tsv.gz",
                        show_col_types = FALSE,
                        comment = "#") %>%
        filter(Gene2SpeciesName == "Danio rerio" &
               Gene1SpeciesName == "Homo sapiens") %>%
        rename(hs_gene = Gene1Symbol,
               dr_gene = Gene2Symbol) %>%
        select(hs_gene,dr_gene) %>%
        distinct())

# In the zfin ortholog, arf6b has no mouse ortholog, but from other sources, it
# is a homolog of Arf6, so I'm going to manually edit that here
# Also, ensemble has Pfn2 as the mouse ortholog of pnf2l, so I'll also include that
orthologs <- bind_rows(tibble(mm_gene = c("Arf6",
                                             "Pfn2"),
                              dr_gene = c("arf6b",
                                                 "pfn2l"),
                              hs_gene = c("ARF6",
                                             "PFN2")),
                       orthologs %>%
                        filter(dr_gene != "arf6b"))

# This will duplicate rows where there are more than one human ortholog per zebrafish gene
fish_genes <- read_tsv("VGLL2NCOA2_27genelist.txt",
                       show_col_types = FALSE) %>%
    rename(dr_gene = gene) %>%
    left_join(orthologs)

# Get 
summarized_data <-
    read_tsv("output/de/DrSkMu_DrFusion_edgeR.txt",
             show_col_types = FALSE) %>%
    rename(dr_gene = Gene,
           dr_logfc = logFC,
           dr_signif = signif) %>%
    select(dr_gene,
           dr_logfc,
           dr_signif,
           DrFusion_mean,
           DrSkMu_mean) %>%
    distinct() %>%
    filter(dr_gene %in% fish_genes$dr_gene) %>%
    left_join(read_tsv("output/de/MmSkMu_MmFusion_edgeR.txt",
                       show_col_types = FALSE) %>%
        rename(mm_gene = Gene,
               mm_logfc = logFC,
               mm_signif = signif) %>%
        select(mm_gene,
               mm_logfc,
               mm_signif,
               MmFusion_mean,
               MmSkMu_mean) %>%
        full_join(orthologs %>%
                  select(mm_gene, dr_gene)) %>%
        filter(!is.na(dr_gene)) %>%
        distinct()) %>%
    left_join(read_tsv("output/de/HsSkMu_HsFusion_edgeR.txt",
                       show_col_types = FALSE) %>%
        rename(hs_gene = Gene,
               hs_logfc = logFC,
               hs_signif = signif) %>%
        select(hs_gene,
               hs_logfc,
               hs_signif,
               HsFusion_mean,
               HsSkMu_mean) %>%
        full_join(orthologs %>%
                  select(hs_gene, dr_gene)) %>%
        filter(!is.na(dr_gene)) %>%
        distinct()) %>%
    left_join(fish_genes %>%
        select(dr_gene, mean_of_development) %>%
        rename(DrDevel_mean = mean_of_development)) %>%
    mutate(gene = paste(dr_gene,
                        "/",
                        mm_gene,
                        "/",
                        hs_gene))

label_table <- list(mm_logfc = "Mouse",
                    hs_logfc = "Human",
                    dr_logfc = "Zebrafish")

cmp_lists <- list(c("mm_logfc", "dr_logfc"),
                  c("hs_logfc", "dr_logfc"),
                  c("mm_logfc", "hs_logfc"))

for (comparisons in cmp_lists) {
    group1 <- comparisons[[1]]
    group2 <- comparisons[[2]]

    if (group1 == "mm_logfc") {
        gene_col <- "mm_gene"
    } else if (group1 == "hs_logfc") {
        gene_col <- "hs_gene"
    }

    sig_g1_col <- str_replace(group1, "logfc", "signif")
    sig_g2_col <- str_replace(group2, "logfc", "signif")

    summarized_data %>%
        select(all_of(c(group1,
                        group2,
                        sig_g1_col,
                        sig_g2_col,
                        gene_col))) %>%
        distinct() %>%
        filter(!is.na(get(sig_g1_col))) %>%
        mutate(sig = paste(get(sig_g1_col), get(sig_g2_col)) %>%
                    str_replace("TRUE TRUE", "Both sig.") %>%
                    str_replace("FALSE TRUE", paste("Sig. in",
                                                    label_table[[group2]])) %>%
                    str_replace("TRUE FALSE", paste("Sig. in",
                                                    label_table[[group1]])) %>%
                    str_replace("FALSE FALSE", "Neither sig.")) %>%
        ggplot(aes(x = get(group1),
                   y = get(group2),
                   color = get(sig_g1_col))) +
        geom_point() +
        ggrepel::geom_text_repel(aes(label = get(gene_col)),
                                 show.legend = FALSE) +
        geom_vline(xintercept = 0) +
        geom_hline(yintercept = 0) +
        scale_color_brewer(palette = "Set2",
                           name = paste0("Significant in\n",
                                         label_table[[group1]])) +
        labs(x = paste(label_table[[group1]], "logFC"),
             y = paste(label_table[[group2]], "logFC"),
             title = paste0("Differential Expression in ",
                            label_table[[group2]],
                            " and ",
                            label_table[[group1]],
                            " Tumors"))

    ggsave(file = paste0("output/figures/",
                         label_table[[group1]],
                         "_",
                         label_table[[group2]],
                         "_diff_expression_scatterplot.png"),
           width = 8,
           height = 7)
}

png(filename = "output/figures/27_genes_heatmap.png",
    width = 2000,
    height = 2500,
    res = 300)
summarized_data %>%
    select(gene,
           DrSkMu_mean,
           DrFusion_mean,
           MmFusion_mean,
           MmSkMu_mean,
           HsFusion_mean,
           HsSkMu_mean,
           DrDevel_mean) %>%
    rename_with(~ str_replace(.x, "SkMu", " muscle") %>%
                str_replace("Devel", " devel.") %>%
                str_remove("_mean") %>%
                str_remove("_mean") %>%
                str_replace("Fusion", " fusion") %>%
                str_replace("^Dr", "D.r.") %>%
                str_replace("^Mm", "M.m.") %>%
                str_replace("^Hs", "H.s.")) %>%
    distinct() %>%
    column_to_rownames("gene") %>%
    as.matrix() %>% 
    pheatmap::pheatmap(scale = "none",
                       display_numbers = TRUE,
                       number_color = "#9c9c9c",
                       legend = FALSE,
                       angle_col = 45,
                       color = colorRampPalette(rev(RColorBrewer::brewer.pal(n = 7,
                                                                             name = "YlOrRd")))(100))
dev.off()
```

## Comparing DEPMAP gene effect and gene expression values for ARF6
```{r plotiRDB, eval=TRUE}
irdb <- read_tsv("iRDB_Arf6_RNAseq.txt", comment = "#") %>%
    mutate(diagnosis_short = fct_reorder(diagnosis_short, FPKM)) %>%
    select(diagnosis_short,
           FPKM) %>%
    na.omit() %>%
    full_join(read_tsv("misc/iRDB_DEPMAP_key.txt")) %>%
    left_join(read_csv("CRISPR_DepMap_22Q1_Public_Score_Chronos_subsetted_Arf6.csv") %>%
        select(lineage_2, ARF6) %>%
        distinct())

ggplot(irdb, aes(x = diagnosis_short, y = FPKM)) +
    geom_boxplot() +
    geom_jitter(alpha = 0.5) +
    labs(x = "Diagnosis",
         y = "FPKM",
         title = "Tumor FPKM data from St. Jude iRDB")

ggplot(irdb, aes(x = ARF6, y = FPKM)) +
    geom_point()

test <- read_csv("misc/ARF6 Expression 22Q1 Public.csv") %>%
    rename(depmap_id = `Depmap ID`,
           ARF6_expr = `Expression 22Q1 Public`,
           cell_line_display_name = `Cell Line Name`) %>%
    full_join(read_csv("CRISPR_DepMap_22Q1_Public_Score_Chronos_subsetted_Arf6.csv") %>%
        select(depmap_id,
               cell_line_display_name,
               lineage_1,
               lineage_2,
               lineage_3,
               ARF6)) %>%
    rename(ARF6_gene_effect = ARF6)

ggplot(test, aes(x = ARF6_gene_effect,
                 y = ARF6_expr,
                 color = lineage_2 == "Rhabdomyosarcoma")) +
    geom_point() +
    geom_point(data = test %>%
               filter(lineage_2 == "Rhabdomyosarcoma"),
               aes(x = ARF6_gene_effect,
                   y = ARF6_expr),
                   color = "#fc8d62",
                   size = 3) +
    ggrepel::geom_text_repel(data = test %>%
                                filter(lineage_2 == "Rhabdomyosarcoma"),
                             aes(x = ARF6_gene_effect,
                                 y = ARF6_expr,
                                 label = cell_line_display_name),
                                 color = "black",
                                 size = 2) +
    labs(x = "ARF6 Gene Effect",
         y = "Expression 22Q1 Public",
         title = "Expression of ARF6 vs DepMap Effect") +
    scale_color_brewer(palette = "Set2",
                       name = "RMS")
ggsave("output/figures/depmap_arf6_expression.png",
       width = 6,
       height = 5)
```

## Tead motifs upstream of 27 developmental genes
```{r motifs, eval=FALSE}
genes_27_names <-
    read_tsv("VGLL2NCOA2_27genelist.txt", show_col_types = FALSE) %>%
    select(gene) %>%
    left_join(read_tsv("/home/gdkendalllab/lab/analyses/mvc002/refs/zebrafish_gene_info.txt.gz",
                       show_col_types = FALSE) %>%
                select(`Gene name`, `Gene stable ID`) %>%
                distinct() %>%
                rename(gene = `Gene name`,
                    gene_stable_id = `Gene stable ID`))

write_tsv(select(genes_27_names, gene_stable_id),
          "output/promoters27/27_genes_zebrafish_gene_ids.txt")
```

```{bash 27_genes_motifs, eval=FALSE}
zgrep -A1 \
    -f output/promoters27/27_genes_zebrafish_gene_ids.txt \
    /home/gdkendalllab/lab/analyses/mvc002/refs/fasta/danRer11_gene_promoters.fasta.gz \
    | grep -v "^--$" \
    > output/promoters27/27genesPromoters.fa
sbatch sbatchCmds/mast.sh
```

### Plot tead motifs upstream of 27 developmental genes
```{r 27_genes_motifs_plot, eval=FALSE}
tead_27 <-
    read_delim(list.files(path = "output/promoters27/mast_out",
                          pattern = "meme.txt",
                          full.names = TRUE),
               show_col_types = FALSE,
               skip = 1,
               comment = "#",
               col_names = c("gene_stable_id",
                             "strand",
                             "motif",
                             "id",
                             "hit_start",
                             "hit_end",
                             "junk",
                             "score",
                             "p_val")) %>%
    mutate(gene_stable_id = str_remove(gene_stable_id, "\\..+")) %>%
    select(-junk) %>%
    full_join(genes_27_names) %>%
    filter(!is.na(id))

long_tead_27 <-
    tead_27 %>%
    select(-motif, -score, -p_val) %>%
    mutate(hit_num = row_number(),
           hit_middle = hit_start + (hit_end - hit_start) / 2 ) %>%
    pivot_longer(cols = c(-gene_stable_id, -strand, -gene, -id, -hit_num, -hit_middle),
                 names_to = "end",
                 values_to = "base")

# Paste together gene_27_names and the four TEAD genes to fill in zeros in table
#

tead_27 %>%
    group_by(id, gene) %>%
    summarize(n_hits = n(), .groups = "drop") %>%
    full_join(tibble(gene = rep(genes_27_names$gene, 4),
                     id = c(rep("TEAD1", nrow(genes_27_names)),
                            rep("TEAD2", nrow(genes_27_names)),
                            rep("TEAD3", nrow(genes_27_names)),
                            rep("TEAD4", nrow(genes_27_names)))) %>%
              distinct()) %>%
    mutate(n_hits = ifelse(is.na(n_hits), 0, n_hits)) %>%
    arrange(id, gene) %>%
    write_tsv("output/promoters27/tead_27_genes_motif_counts.txt")

for (tead_ver in c("TEAD1", "TEAD2", "TEAD3", "TEAD4")) {
    plot_name <-
        ggplot() +
        geom_point(data = filter(long_tead_27, id == tead_ver),
                   aes(x = hit_middle,
                       y = gene),
                  size = 3,
                  color = "black",
                  shape = 18) +
        xlim(0, 2000) +
        scale_color_brewer(palette = "Set1",
                        name = "Strand") +
        labs(x = "Promoter position",
             y = "Gene",
             title = paste(tead_ver, "Motifs in Promoters of Developmental Genes"))

    ggsave(paste0("output/figures/", tead_ver, "_27_genes_promoter_locations.png"),
            width = 8,
            height = 5,
            plot = plot_name)
}
```

## Count reads mapping across VGLL2-NCOA2 fusion junction
Make sure samtools is on the path before running this chunk.
I used samtools v1.15
```{r stuff, eval=TRUE}
# Table with known juction locations for each sample
breakpoint_list <-
    list("VGLL2-NCOA2_x2_x13" = 597,
         "VGLL2-NCOA2_x2_x14" = 597,
         "VGLL2_NCOA2_x3_x14" = 1119,
         "hVGLL2NCOA2_CDS"    = 391)

fusion_list <-
    list("EGAR00001508614_SARC061"           = c("VGLL2-NCOA2_x2_x13",
                                                 "VGLL2-NCOA2_x2_x14"),
         "EGAR00001508618_SARC065"           = c("VGLL2-NCOA2_x2_x14",
                                                 "VGLL2_NCOA2_x3_x14"),
         "EGAR00001508623_SARC070-Primary"   = c("VGLL2-NCOA2_x2_x13",
                                                 "VGLL2-NCOA2_x2_x14"),
         "EGAR00001508624_SARC070-Relapse1"  = c("VGLL2-NCOA2_x2_x13",
                                                 "VGLL2-NCOA2_x2_x14"),
         "EGAR00001508656_SARC102"           = c("VGLL2-NCOA2_x2_x13",
                                                 "VGLL2-NCOA2_x2_x14"))

get_data <- function(sample_name) {
    if (sample_name %in% names(fusion_list)) {
        breakpoints <- breakpoint_list[fusion_list[[sample_name]]]
    } else {
        breakpoints <- breakpoint_list["hVGLL2NCOA2_CDS"]
    }

    read_counts <- tibble(ref = rep(NA, length(breakpoints)),
                          fusion_reads = rep(NA, length(breakpoints)),
                          sample_name = rep(NA, length(breakpoints)))
    for (i in seq_len(length(breakpoints))) {
        buffer_size <- 25
        upper_bound <- breakpoints[[i]] + buffer_size
        lower_bound <- breakpoints[[i]] - buffer_size
        filter_cmd <- paste0("samtools view output/fusionAligned/",
                            sample_name,
                            "Aligned.out.bam | grep ",
                            names(breakpoints)[i],          # Get fusion chr
                            " | awk '$4 <= ", lower_bound,  # Get pairs that flank the fusion point
                            " && $8 >= ", upper_bound,
                            " && $5 >= 200 && $7 == \"=\" {print $_}'", # Filter out poorly mapping and any where the mate mapped to another "chr"
                            " | cut -f 1 | perlUnique.pl | wc -l") # Count number of unique read
        read_counts$fusion_reads[i] <- as.numeric(system(filter_cmd, intern = TRUE))
        read_counts$sample_name[i] <- sample_name
        read_counts$ref[i] <- names(breakpoints)[i]
    }
    return(read_counts)
}

samples <- system("ls output/fusionAligned/*.bam", intern = TRUE) %>%
    str_remove(".+/") %>%
    str_remove("Aligned.out.bam")

names(samples) <- samples

fusion_mapped <- lapply(samples, function(x) get_data(x)) %>%
    bind_rows()

get_reads_cmd <- "grep 'Uniquely mapped reads number' output/aligned/*/*Log.final.out"

fusion_data <- tibble(data_in = system(get_reads_cmd, intern = TRUE)) %>%
    separate(data_in,
             sep = "\t",
             into = c("sample_name", "reads_mapped")) %>%
    mutate(sample_name = sample_name %>%
                str_remove(".+/") %>%
                str_remove("Log.final.out:.+"),
                reads_mapped = as.numeric(reads_mapped),
           M_reads_mapped = reads_mapped / 1000000) %>%
    right_join(fusion_mapped,
              by = "sample_name") %>%
    mutate(fusions_per_M = fusion_reads / M_reads_mapped) %>%
    select(-M_reads_mapped) %>%
    left_join(read_tsv("misc/sampleMetadata.txt",
                       show_col_types = FALSE) %>%
                select(sample, group, description) %>%
                rename(sample_name = sample))

fusion_data %>%
    gt::gt() %>%
    gt::fmt_number(columns = 2, decimals = 0, sep_mark = ",") %>%
    gt::fmt_number(columns = 5, decimals = 2) %>%
    gt::cols_label(sample_name = "Sample",
                   reads_mapped = "Reads Mapped",
                   fusion_reads = "Fusions Detected",
                   ref = "Fusion",
                   fusions_per_M = md("Fusions/Million Reads"),
                   group = "Group",
                   description = "Description") %>%
    gt::cols_width(fusions_per_M ~ px(125),
                   fusion_reads ~ px(100)) %>%
    gt::gtsave(file = "output/figures/fusionsMapped.png")

ggplot(fusion_data, aes(x = group, y = fusions_per_M + 1)) +
    ggbeeswarm::geom_beeswarm(cex = 2) +
    labs(x = "",
         y = "Fusions per million mapped reads",
         title = "Comparison of VGLL2-NCOA2 Fusion Expression") +
    scale_y_log10()

ggsave("output/figures/fusionExpression.png")
```

## Testing for correlation between fusion counts and gene expression of up-regulated genes
```{r corrFusion, eval=FALSE}
de_results <-
    full_join(fusion_data, read_tsv("output/MmTumors_edgeR.txt", show_col_types = FALSE) %>%
        column_to_rownames("Gene") %>%
        filter(signif == "TRUE" & logFC > 0) %>%
        select(starts_with("A377")) %>%
        select(-`A377-A378T7`, -`A377-A378T8`) %>%
        t() %>%
        as.data.frame() %>%
        rownames_to_column("sample_name"))


ggplot(de_results, aes(x = fusions_per_M, y = Tspan33)) +
    geom_smooth(method = "lm", se = FALSE) +
    geom_point() +
    ggtitle("Tspan33")

cor.test(de_results$fusions_per_M, de_results$Wisp1)

cor_testing <- tibble(p_val = lapply(colnames(de_results)[5:ncol(de_results)],
                      function(x) cor.test(de_results$fusions_per_M,
                                           de_results[[x]])$p.value) %>%
                        as.numeric(),
                      pearson_cor = lapply(colnames(de_results)[5:ncol(de_results)],
                      function(x) cor.test(de_results$fusions_per_M,
                                           de_results[[x]])$estimate) %>%
                        as.numeric(),
                      gene = colnames(de_results)[5:ncol(de_results)]) %>%
    arrange(p_val) %>%
    mutate(fdr = qvalue::qvalue(p_val)$qvalues)



names(test) <- colnames(de_results)[5:ncol(de_results)]

```

```{r sessionInfo}
sessionInfo()
```

## AGDEX analysis
Keep this chunk last in the analysis since it borks my namespace >:(

Compare:
-   VGLL2NCOA2 human and fish tumors vs. mature skeletal muscle
-   VGLL2NCOA2 human and fish tumors vs. KRAS driven RMS
-   Mouse VGLL2NCOA2 and fish tumors vs. mature skeletal muscle
```{r agdex, child='agdex_child.Rmd', eval=TRUE}
```